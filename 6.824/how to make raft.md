
# How to make raft

## 共识

在分布式系统中，参与节点对某一个提案达成一致的过程，称之为共识。如何构建一个算法，能够稳定的构建共识，这是一个分布式领域的经典问题。

在现在盛行的微服务架构中，每个服务节点被视作无状态的，客户端访问每一个节点，都能获取一样的服务。这种架构隐藏了一个背景，就是状态不存储在节点中，相当于把问题后移了，状态从服务节点本身，后移到像是MySql，Redis、FDS这样的存储系统中。如果存储系统是单节点的话，整个服务架构瓶颈就集中在了这个单节点当中。如何做一个有状态的分布式系统，核心问题就是节点就请求达成共识，使得在系统中某个时刻每个节点都能有相同的有效数据。

## 背景

### 通信

我们假定系统中每个节点只能通过网络通信交流。网络请求时间没有上确界，节点不知道自己发往别的节点的请求是否到达，也不知道到达的时间。导致了以下几个结果：

1. 节点只能通过目标节点的回复才能确认消息已经到达。

2. 当一个请求没有回复时，节点不能确定这个请求是没发出去，还是发出去没有接收，还是接收了没有处理，还是处理了没有返回，还是返回了没有收到。

3. 当一个节点没有响应，其它节点不能确定这个节点是没有存活，还是网络连接问题。

网络通信的特质就是不可靠的，在一个不可靠的系统中构建一个可靠的系统，是一个很大的挑战。

### 主从架构

一个最简单的共识算法实现方式，就是主从架构。系统中某一个节点作为主节点，其它节点作为从节点，主节点接受请求，并把请求分发给从节点，从节点接受从主节点分发的请求。节点间达成共识，核心就是主节点做出共识，从节点做出跟随。

### 复制状态机

从一个初始状态开始，经过一系列仅依赖于之前状态的确定性操作，达到另一个状态。重演这样的操作，和之前获得的状态应该是一样的。比如纯函数，从一个初始值开始，经过一系列纯函数操作，
